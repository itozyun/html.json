# ソースコードの実際に即したテキストノードの空白文字の削除

HTML 文書のソースコードは、マークアップエンジニアの可読性の為に、ブラウザ上には表示されない改行等の空白文字を含む。

HTML から json への変換時にこれらの空白文字を除去して、json をコンパクトにする。

半角スペースの保護には `\u0020` または `&#x20;` または `&#32;` を使う。

## 1. テキストノードの後ろの空白文字

次のようなソースコードがある場合、`First` を含むテキストノードは、`First\n` になる。1つの改行文字が続く。

~~~html
<ol>
<li>Fisrt
<li>Second
<li>Third
</ol>
~~~

次の場合、`First` を含むテキストノードは、`First⏎  ` になる。1つの改行文字と1文字以上の半角スペースないしタブが続く。

~~~html
<ol>
  <li>Fisrt
  <li>Second
  <li>Third
</ol>
~~~

## 2. テキストノードの頭の空白文字

`春は、あけぼの。`を含むテキストノードは、`⏎春は、あけぼの。⏎` になる。
1つの改行文字に続いて `春は、あけぼの。` が出現する。

~~~html
<p>
春は、あけぼの。
<p>
やうやうしろくなりゆく山ぎは、すこし明かりて、紫だちたる雲の、細くたなびきたる。
~~~

`春は、あけぼの。`を含むテキストノードは、`⏎    春は、あけぼの。⏎` になる。
1つの改行文字と1文字以上の半角スペースないしタブに続いて `春は、あけぼの。` が出現する。

~~~html
<p>
    春は、あけぼの。
<p>
    やうやうしろくなりゆく山ぎは、すこし明かりて、紫だちたる雲の、細くたなびきたる。
~~~

次の書き方はみない。連続する空白文字を1つの半角スペースにして残す。

~~~html
<p> 春は、あけぼの。
~~~

## 3. 空白文字を残すパターン

`/` の前後の半角スペースは残るのが適切。改行文字がテキストノードの前後に無いため、半角スペースを残す判断が出来る。

~~~html
Page: <b>1</b> / <b>8</b>
<!--          ^^^     -->
~~~

## 4. `<pre>` 内の改行文字前のスペース、タブ

`<pre>` 下のテキストノードには、特別なルールで最適化を行う。

### 4.1. 開始タグの直後と、閉じタグの直前の改行文字を削除

~~~html
<pre>⏎
10 PRINT "HELLO, WORLD!"⏎
20 END⏎
</pre>
~~~
↓

~~~html
<pre>10 PRINT "HELLO, WORLD!"⏎
20 END</pre>
~~~

~~~json
["PRE", "⏎10 PRINT \"HELLO, WORLD!\"⏎20 END⏎"]
~~~
↓

~~~json
["PRE", "10 PRINT \"HELLO, WORLD!\"⏎20 END"]
~~~

### 4.2. 改行文字の前のスペース、タブを削除する

改行文字の直前にある半角スペースとタブを削除する。(`trimWhitespaces:"aggressive"`)

~~~html
<pre>
10 PRINT "HELLO, WORLD!"    ⏎
20 END
</pre>
~~~

### 4.3. 単一の改行文字を前の要素のテキストノードに含める

改行文字を前の要素(`<i>`)に含めてしまった方が、テキストノードを節約できる

~~~html
<pre><i>10 PRINT "HELLO, WORLD!"</i>⏎
<b>20 END</b></pre>
~~~

↓

~~~html
<pre><i>10 PRINT "HELLO, WORLD!"⏎
</i><b>20 END</b></pre>
~~~

~~~json
["PRE",
    ["I", "10 PRINT \"HELLO, WORLD!\""],
    "⏎",
    ["B", "20 END"]
]
~~~
↓

~~~json
["PRE",
    ["I", "10 PRINT \"HELLO, WORLD!\"⏎"],
    ["B", "20 END"]
]
~~~

### 4.4 インライン要素の下のテキストノードの後ろに半角スペースやタブがある場合

1. インライン要素の下のテキストノードの後ろの半角スペース、タブも削除する。但し、後続が改行文字の場合に限る。(`trimWhitespaces:"aggressive"`)
2. `</pre>` の直前の行の半角スペース、タブも削除する。(`trimWhitespaces:"aggressive"`)

~~~html
<pre><i>10 PRINT "HELLO, WORLD!"  </i>⏎
<b>20 END   </b></pre>
~~~
↓

~~~html
<pre><i>10 PRINT "HELLO, WORLD!"⏎
</i><b>20 END</b></pre>
~~~
